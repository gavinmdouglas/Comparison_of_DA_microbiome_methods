---
title: "Figure3"
author: "Jacob T. Nearing"
date: "1/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggrepel)
library(cowplot)
```

#load in data
```{r}
filt_results <- readRDS("/home/jacob/GitHub_Repos/Hackathon_testing/Data/Filt_results.RDS")
unfilt_results <- readRDS("/home/jacob/GitHub_Repos/Hackathon_testing/Data/Unfilt_results.RDS")


tool_names <- c(aldex2="ALDEx2", ancom="ANCOM-II", corncob="corncob", deseq2="DESeq2", edger="edgeR", lefse="LEfSe", 
                limma_voom_TMM="limma voom (TMM)", limma_voom_TMMwsp="limma voom (TMMwsp)", maaslin2="MaAsLin2",
                maaslin2rare="MaAsLin2 (rare)", metagenomeSeq="metagenomeSeq", ttestrare="t-test (rare)", 
                wilcoxonclr="Wilcoxon (CLR)", wilcoxonrare="Wilcoxon (rare)")
```


## PCoA of Binary Distances for each tool
```{r}
## Start with filtered data
## We want to weight each dataset equally so we will take the mean the binary distance for all datasets for each tool

first_data = TRUE
for(dataset in filt_results){
  
  ### anything under 0.05 set to sig
  bin_dataset <- dataset[[2]]

  ## if significant set to 2
  bin_dataset[bin_dataset < 0.05] <- 2
  ## if not significant set to 0
  bin_dataset[bin_dataset != 2] <- 0
  ## if was significant set value to 1
  bin_dataset[bin_dataset==2] <- 1
  
  if(first_data){
    dataset_binary_dist <- dist(t(bin_dataset), method="binary")
    first_data <- F
  }else{
    dataset_binary_dist <- dataset_binary_dist + dist(t(bin_dataset), method="binary")
  }
  
}

dataset_binary_dist <- dataset_binary_dist/length(filt_results)

filt_pcoa <- cmdscale(d=dataset_binary_dist, k=5, eig=T)

eig_percent <- filt_pcoa$eig*100/sum(filt_pcoa$eig) 
eig_percent
names(eig_percent) <- c(1:14)
eig_filt_plot <- ~barplot(eig_percent, xlab='Component', ylab="Percent explained", main="Filtered data", ylim = c(0,30))

PC1_set <- paste("PC1 (", as.character(format(round(eig_percent[1], 2), nsmall = 2)), "%)", sep="")
PC2_set <- paste("PC2 (", as.character(format(round(eig_percent[2], 2), nsmall = 2)), "%)", sep="")
PC3_set <- paste("PC3 (", as.character(format(round(eig_percent[3], 2), nsmall = 2)), "%)", sep="")
PC4_set <- paste("PC4 (", as.character(format(round(eig_percent[4], 2), nsmall = 2)), "%)", sep="")


coords <- filt_pcoa$points
## try ggord.

plot_data_filt <- data.frame(PC1=coords[,1], PC2=coords[,2], PC3=coords[,3], PC4=coords[,4])


## fix tool names
plot_data_filt$Tool <- tool_names[rownames(plot_data_filt)]


plot12 <- ggplot(plot_data_filt, aes(x=PC1, y=PC2, label=Tool)) + geom_point() +
  xlab(PC1_set) + ylab(PC2_set) + geom_text_repel() + theme_bw() +
  theme(text = element_text(size=16, color="black"), axis.text = element_text(color="black"))
plot12

plot13 <- ggplot(plot_data_filt, aes(x=PC1, y=PC3, label=Tool)) + geom_point() +
  xlab(PC1_set) + ylab(PC3_set) + geom_text_repel() + theme_bw() +
  theme(text = element_text(size=16, color="black"), axis.text = element_text(color="black"))
plot13



plot14 <- ggplot(plot_data_filt, aes(x=PC1, y=PC4, label=Tool)) + geom_point() +
  xlab(PC1_set) + ylab(PC4_set) + geom_text_repel() + theme_bw() +
  theme(text = element_text(size=16, color="black"), axis.text = element_text(color="black"))
plot14


## all plots in one


supp_filtered <- plot_grid(eig_filt_plot, plot12, plot13, plot14,
                            labels=c('A', 'B', 'C', 'D'),
                            nrow=2, label_size=20)
supp_filtered

ggsave(filename="../Display_items/Supp_figures/Supp_PCOA_Filt.pdf",
       plot = supp_filtered, width = 10, height=10, units="in", dpi=600)

```



```{r}
first_data = TRUE

## need to remove dataset where one tool didn't finish.
No_FreshWater_Adj_p_tabs_unfilt <- unfilt_results
No_FreshWater_Adj_p_tabs_unfilt[[2]] <- NULL

for(dataset in No_FreshWater_Adj_p_tabs_unfilt){
  
  ### anything under 0.05 set to sig
  bin_dataset <- dataset[[2]]
  
  ## if significant set to 2
  bin_dataset[bin_dataset < 0.05] <- 2
  ## if not significant set to 0
  bin_dataset[bin_dataset != 2] <- 0
  ## if was significant set value to 1
  bin_dataset[bin_dataset==2] <- 1
  
  if(first_data){
    dataset_binary_dist_unfilt <- dist(t(bin_dataset), method="binary")
    first_data <- F
  }else{
    dataset_binary_dist_unfilt <- dataset_binary_dist_unfilt + dist(t(bin_dataset), method="binary")
  }
  
}

dataset_binary_dist_unfilt <- dataset_binary_dist_unfilt/37

unfilt_pcoa <- cmdscale(d=dataset_binary_dist_unfilt, k=5, eig=T)

eig_percent_unfilt <- unfilt_pcoa$eig*100/sum(unfilt_pcoa$eig) 
eig_percent_unfilt
names(eig_percent_unfilt) <- c(1:14)
eig_percent_unfilt_plot <- ~barplot(eig_percent_unfilt, xlab='Component', ylab="Percent explained", main="Unfiltered data", ylim = c(0,30))

PC1_set_unfilt <- paste("PC1 (", as.character(format(round(eig_percent_unfilt[1], 2), nsmall = 2)), "%)", sep="")
PC2_set_unfilt <- paste("PC2 (", as.character(format(round(eig_percent_unfilt[2], 2), nsmall = 2)), "%)", sep="")
PC3_set_unfilt <- paste("PC3 (", as.character(format(round(eig_percent_unfilt[3], 2), nsmall = 2)), "%)", sep="")
PC4_set_unfilt <- paste("PC4 (", as.character(format(round(eig_percent_unfilt[4], 2), nsmall = 2)), "%)", sep="")

coords_unfilt <- unfilt_pcoa$points
## try ggord.

plot_data_unfilt <- data.frame(PC1=coords_unfilt[,1], PC2=coords_unfilt[,2], PC3=coords_unfilt[,3], PC4=coords_unfilt[,4])


## fix tool names
plot_data_unfilt$Tool <- tool_names[rownames(plot_data_unfilt)]


plot12_unfilt <- ggplot(plot_data_unfilt, aes(x=PC1, y=PC2, label=Tool)) + geom_point() +
  xlab(PC1_set_unfilt) + ylab(PC2_set_unfilt) + geom_text_repel() + theme_bw() +
  theme(text = element_text(size=16, color="black"), axis.text = element_text(color="black"))
plot12_unfilt

plot13_unfilt <- ggplot(plot_data_unfilt, aes(x=PC1, y=PC3, label=Tool)) + geom_point() +
  xlab(PC1_set_unfilt) + ylab(PC3_set_unfilt) + geom_text_repel() + theme_bw() +
  theme(text = element_text(size=16, color="black"), axis.text = element_text(color="black"))
plot13_unfilt


plot14_unfilt <- ggplot(plot_data_unfilt, aes(x=PC1, y=PC4, label=Tool)) + geom_point() +
  xlab(PC1_set_unfilt) + ylab(PC4_set_unfilt) + geom_text_repel() + theme_bw() +
  theme(text = element_text(size=16, color="black"), axis.text = element_text(color="black"))
plot14_unfilt


supp_unfiltered <- plot_grid(eig_percent_unfilt_plot, plot12_unfilt, plot13_unfilt, plot14_unfilt,
                            labels=c('A', 'B', 'C', 'D'),
                            nrow=2, label_size=20)
supp_unfiltered

ggsave(filename="../Display_items/Supp_figures/Supp_PCOA_Unfilt.pdf",
       plot = supp_unfiltered, width = 10, height=10, units="in", dpi=600)

```

```{r}
Figure3 <- plot_grid(plot12_unfilt + ggtitle("Unfiltered data") + theme(plot.title = element_text(hjust = 0.5)),
                     plot12  + ggtitle("Filtered data") + theme(plot.title = element_text(hjust = 0.5)),
                     labels = c("A", "B"),
                     label_size=20)
Figure3

ggsave(filename="../Display_items/Main_figures/Figure3.pdf",
       plot = Figure3, width = 10, height=4.5, units="in", dpi=600)

```